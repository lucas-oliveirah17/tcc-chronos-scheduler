#!/bin/bash

# Definição de Cores
WHITE='\033[1;37m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BLUE='\033[1;34m'
NC='\033[0m' # No Color (Reset)

# Detecção automática do comando Docker Compose
if docker-compose version >/dev/null 2>&1; then
    DOCKER_CMD="docker-compose"
else
    DOCKER_CMD="docker compose"
fi

# Carrega variáveis do arquivo .env se ele existir
if [ -f .env ]; then
    set -a
    source .env
    set +a
else
    echo -e "${RED}ERRO: Arquivo .env não encontrado!${NC}"
    exit 1
fi

# Função auxiliar para verificar se um container está rodando
is_running() {
    # Retorna 0 (true) se estiver rodando, 1 (false) caso contrário
    ${DOCKER_CMD} ps --filter "status=running" --format "{{.Names}}" | grep -q "^$1$"
}

# Função para exibir URLs úteis
show_urls() {
    # Argumento $1: pode ser "--all" ou "--dev"
    local MODE=$1

    if [ -z "$FRONT_PORT" ] || [ -z "$BACK_PORT" ] || [ -z "$BASE_URL" ]; then
        echo -e "\n${YELLOW}AVISO: Variáveis de ambiente não carregadas. Verifique o seu arquivo .env!${NC}"
    else
        # Variável para acumular os links
        LINKS_CONTENT=""

        if is_running "chronos-frontend"; then
            LINK_FRONT="${BLUE}\e]8;;http://localhost:${FRONT_PORT}\ahttp://localhost:${FRONT_PORT}\e]8;;\a${NC}"
            LINKS_CONTENT="${LINKS_CONTENT}${CYAN}Frontend:${NC} ${LINK_FRONT}\n"
        fi

        if is_running "chronos-backend" && [ "$MODE" == "--all" ]; then
            LINK_BACK="${BLUE}\e]8;;${BASE_URL}\a${BASE_URL}\e]8;;\a${NC}"
            LINK_SWAGGER="${BLUE}\e]8;;http://localhost:${BACK_PORT}/swagger-ui.html\ahttp://localhost:${BACK_PORT}/swagger-ui.html\e]8;;\a${NC}"
            LINKS_CONTENT="${LINKS_CONTENT}${CYAN}Backend: ${NC} ${LINK_BACK}\n"
            LINKS_CONTENT="${LINKS_CONTENT}${CYAN}Swagger: ${NC} ${LINK_SWAGGER}\n"
        fi

        if is_running "chronos-pgadmin"; then
            LINK_ADMIN="${BLUE}\e]8;;http://localhost:5050\ahttp://localhost:5050\e]8;;\a${NC}"
            LINKS_CONTENT="${LINKS_CONTENT}${CYAN}pgAdmin: ${NC} ${LINK_ADMIN}\n"
        fi

        if [ ${#LINKS_CONTENT} -gt 1 ]; then
            echo -e "\n${WHITE}--- LINKS ÚTEIS ---${NC}"
            echo -e "${WHITE}DICA: Segure ${YELLOW}Ctrl${WHITE} e clique no link para abrir no navegador.${NC}"
            printf "$LINKS_CONTENT"
            echo -e "${CYAN}==============================================================${NC}"
        fi
    fi
}

# Função para exibir a ajuda
show_help() {
    echo -e "${CYAN}==============================================================${NC}"
    echo -e "${CYAN}             UTILITÁRIO DE AUTOMAÇÃO CHRONOS                  ${NC}"
    echo -e "${CYAN}==============================================================${NC}"
    
    echo -e "\n${WHITE}--- FLUXO DE TRABALHO ---${NC}"
    echo -e "  ${GREEN}-s, start${NC}      - Inicia ambiente completo (Docker)"
    echo -e "  ${MAGENTA}-d, dev${NC}        - Modo IDE (Sobe infra e para Backend no Docker)"
    echo -e "  ${YELLOW}-p, stop${NC}       - Para todos os containers (mantém dados)"
    echo -e "  ${YELLOW}-r, restart${NC}    - Recompila e reinicia apenas o Backend"

    echo -e "\n${WHITE}--- DIAGNÓSTICO E INSPEÇÃO ---${NC}"
    echo -e "  ${CYAN}-st, status${NC}     - Lista containers ativos e portas"
    echo -e "  ${CYAN}-l, logs${NC}       - Exibe logs em tempo real (Ctrl+C p/ sair)"
    echo -e "  ${CYAN}-db, database${NC}   - Abre o terminal SQL (psql) do Postgres"

    echo -e "\n${WHITE}--- MANUTENÇÃO E LIMPEZA ---${NC}"
    echo -e "  ${RED}-rb, rebuild${NC}    - Força reconstrução das imagens (sem cache)"
    echo -e "  ${RED}-c, clean${NC}      - RESET TOTAL: Remove containers e apaga o banco"

    echo -e "\n${WHITE}--- OUTROS ---${NC}"
    echo -e "  ${GREEN}-h, help${NC}       - Mostra esta tela de ajuda"
    echo -e "${CYAN}==============================================================${NC}"
}

# Função para sincronizar variáveis com o application-local.properties do Backend
sync_backend_properties() {
    local PROPERTIES_FILE="backend/src/main/resources/application-local.properties"
    
    echo -e "${CYAN}>>> [SYNC] Atualizando application-local.properties...${NC}"
    
    mkdir -p "$(dirname "$PROPERTIES_FILE")"

    cat <<EOF > "$PROPERTIES_FILE"
# ARQUIVO GERADO AUTOMATICAMENTE PELO SCRIPT CHRONOS
# DATA: $(date)

server.port=${BACK_PORT}

#Conexão com o Banco do Docker
spring.datasource.url=jdbc:postgresql://localhost:${DB_PORT}/${DB_NAME}
spring.datasource.username=${DB_USER}
spring.datasource.password=${DB_PASS}

# JWT
# Pode ser gerado no bash, via: openssl rand-base64 32
jwt.secret=${JWT_SECRET}
jwt.expiration.hours=${JWT_EXPIRATION_HOURS}

# Configurações de desenvolvimento
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
EOF

    echo -e "${GREEN}>>> [SYNC] Arquivo de propriedades sincronizado com sucesso!${NC}"
}

case "$1" in
    start|-s)
    echo -e "${GREEN}>>> [START] Iniciando ambiente Chronos...${NC}"
    ${DOCKER_CMD} up -d
    show_urls "--all"
    ;;

    dev|-d)
    echo -e "${MAGENTA}>>> [DEV MODE] Preparando infraestrutura para desenvolvimento...${NC}"
    # Para o backend explicitamente caso ele esteja rodando no Docker
    ${DOCKER_CMD} stop backend
    
    # chamada de função de sincronização
    sync_backend_properties
    
    echo -e "${YELLOW}Dica: Agora voce pode rodar o backend direto pela sua IDE.${NC}"
    # Sobe apenas os serviços listados abaixo
    ${DOCKER_CMD} up -d --no-build --no-deps db-postgres pgadmin frontend
    show_urls "--dev"
    ;;

    stop|-p)
    echo -e "${YELLOW}>>> [STOP] Parando containers...${NC}"
    ${DOCKER_CMD} stop
    ;;

    restart|-r)
    echo -e "${CYAN}>>> [RESTART] Recompilando backend e reiniciando...${NC}"
    ${DOCKER_CMD} up -d --build backend
    show_urls "--all"
    ;;

    status|-st)
    echo -e "${CYAN}>>> Status dos containers:${NC}"
    ${DOCKER_CMD} ps
    show_urls "--all"
    ;;

    logs|-l)
    echo -e "${CYAN}>>> [LOGS] Exibindo logs dos servicos...${NC}"
    ${DOCKER_CMD} logs -f
    ;;

    database|-db)
    echo -e "${CYAN}>>> Abrindo terminal do banco (digite a senha do .env)...${NC}"
    # Puxa o nome do banco do .env automaticamente
    docker exec -it chronos-db psql -U chronos_admin -d chronos_db
    ;;

    rebuild|-rb)
    echo -e "${RED}>>> Reconstruindo imagens do zero...${NC}"
    ${DOCKER_CMD} build --no-cache
    ${DOCKER_CMD} up -d
    show_urls "--all"
    ;;

    clean|-c)
    echo -e "${RED}>>> [CLEAN] CUIDADO: Removendo containers e volumes de dados...${NC}"
    ${DOCKER_CMD} down -v
    ;;
    
    help|--help|-h)
    show_help
    ;;
    *)
    echo -e "${RED}ERRO: Comando '$1' nao reconhecido.${NC}"
    show_help
    exit 1
esac
